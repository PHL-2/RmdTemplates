---
title: |
  ![](../../aux_files/pdf_generation/forKnitting/logo_blk.png){width=5in}  
  `r paste0('Results for wastewater ddPCR run ', basename(here()))`
author: "Philadelphia Public Health Labs"
date: \today
geometry: margin=2cm
output:
    pdf_document:
        template: ../../aux_files/pdf_generation/forKnitting/toc_after.tex
        keep_tex: false
        toc: true
        toc_depth: 3
        includes:
            in_header: ../../aux_files/pdf_generation/forKnitting/TeX_packages_commands.sty

---


\newpage
\tableofcontents

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy=TRUE,
  cache=FALSE,
  cache.lazy = FALSE,
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  #fig.height = figHeight,
  dpi=300,
  dev.args = list(pdf = list(useDingbats = FALSE))
  )
  
library(tidyverse)
library(pander)

```


```{r child = 'code/preamble.Rmd', include = FALSE}
```


\newpage

# Summary checks and results

## Flags

```{r summary droplet counts check}


if (droplet_test) {
  print("Detected wells with <10000 droplets; wells will be excluded from analysis")
  print(paste("Wells with <10000 droplets removed:", paste(droplet_test_wells, collapse = ", "), collapose = ""))
  }

# if (sum(d_pre$Droplet_count<10000) > 0) {
#   print("Detected wells with <10000 droplets; wells will be excluded from analysis")
#   }

if (variance_test | signal_check) {
  if (!all_var_check) {
    print("Detected high variation in non-summarized wells; no wells removed")
  } else {
    if (variance_test) {
      print(paste("Detected wells with high variance:", paste(wellsToRemove1, collapse =", "), collapse = ""))
    } 
    if(signal_check) {
      print(paste("Detected wells with no signal:", paste(wellsToRemove2, collapse =", "), collapse = ""))
    }
    print(paste("Wells", paste(wellsToRemove, collapse = ", "), "have been removed", collapse = ""))
  }
}
# if ((sum(d_sd$cv_conc>30, na.rm = T) > 0 & sum(d_sd$sd_from_mean > 1, na.rm = T) > 0) | sum(d_sd$outlier_median > 5, na.rm = T) > 0) {
#   print("Detected high variation; please check samples")
#   }

```

## Results

```{r summary results}

pander(ww_conc_result_summarised,
       digits = 10, round = 2)

```


\newpage

# Introduction

This report summarises the results for SARS-COV-2 waste water detection by ddPCR using the BioRad PREvalence ddPCR SARS-CoV-2 Wastewater Quantification Kit (manual can be found [here](https://www.bio-rad.com/sites/default/files/webroot/web/pdf/lsr/literature/10000142158.pdf)). In this process, we quantify the amount of SARS-COV-2 N2 and E genes in waste water samples. Our controls for this experiment are SARS-COV-2 and MHV and are spiked into control buffer (old wastewater).

# Sample summary

```{r table of samples}

d_pre %>%
  select(Sample, Target, Spiked, Sample_received, Well) %>%
  distinct() %>%
  pander()

```


\newpage
\blandscape

# Quality control

## Droplet count

```{r checking droplet count, fig.width=16, fig.height = 4.2}

if (droplet_test) {
  print("Detected wells with <10000 droplets; wells will be excluded from analysis")
  print(paste("Wells with <10000 droplets removed:", paste(droplet_test_wells, collapse = ", "), collapose = " "))
  pander(
    d_pre %>%
      filter(Droplet_count< 10000) %>%
      select(Well, Sample, Spiked, Sample_received, Droplet_count) %>%
      distinct(),
      split.table = 500
    ) 
  } else {
    print("No detected wells with <10000 droplets")
  }

d_pre %>%
  filter(Target == targetsInfo[1]) %>%
  ggplot(aes(x = Well, y = Droplet_count)) +
  geom_col() + 
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  )

```

```{r child = 'code/scripts/cluster_graph.Rmd', eval = ampCheck}
```

## Variance check

```{r variance check}

if (variance_test) {
  if (!all_var_check) {
    varNominal <- TRUE
    print("Detected high variation in non-summarized wells; no wells removed")
  } else {
      varNominal <- FALSE
      print(paste("Detected wells with high variance:", paste(wellsToRemove1, collapse =", "), collapse = ""))
  }

  var_pander <- d_sd %>%
    select(Well, Sample, Sample_received, Target, conc = `Conc(copies/uL)`, avg_conc, cv_conc, med_conc = median_conc, MAD = outlier_median, GESD_q
           ) %>%
    filter(MAD >=7 | GESD_q <= 0.01
           ) %>%
    arrange(Sample, Target) %>%
    distinct()

  pander(var_pander,
      split.table = 500
  )
} else {
  varNominal <- TRUE
  print("Variation nominal")
}

```

## Signal Check

```{r}

if (signal_check) {
    print(paste("Detected wells with no signal:", paste(wellsToRemove2, collapse =", "), collapse = " "))
  signalNominal <- FALSE
} else {
  signalNominal <- TRUE
  print("Signal nominal")
}


```


```{r}

if (signalNominal & varNominal) {
  notNominal <- FALSE
} else {
  notNominal <- TRUE
}

```

## Wells removed

```{r, eval = !notNominal}

print("No additional wells removed.")

```

```{r, eval = notNominal}

    print(paste("Wells", paste(wellsToRemove, collapse = ", "), "have been removed", collapse = ""))

```

\elandscape

## Number of overall positive droplets per sample

```{r, fig.height = 8.2}

d %>% 
  group_by(Well, Sample, Spiked, Sample_received) %>%
  summarize(overall_positives = sum(Positives), Droplets = mean(Droplet_count)) %>%
  mutate(percentage_positive = overall_positives / Droplets * 100) %>%
  ungroup() %>%
  select(Well, Sample, Sample_received, percentage_positive) %>%
  #filter(Spiked == "Spiked") %>%
  ggplot(aes(x=Well, y=percentage_positive, fill = Sample)) +
  geom_col(position = "dodge") +
  #scale_fill_manual(values = c("orange", "purple", "dodgerblue2")) +
  facet_grid(Sample_received ~ Sample, scales = "free_x") +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = "Percent of positive droplets in all data",
    y = "Percent of positive droplets",
    x = "Samples"
  )
  

```

## All Data

```{r, fig.height = figHeight}

#All data
d %>%
  mutate(SampleType = ifelse(grepl(pattern = "East|West", x = Sample) & Spiked == "Unspiked", "NegMHV", SampleType),
         SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
  #filter(Spiked == "Spiked") %>%
  ggplot(aes(x=Sample, y=Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  theme_light() +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = "Number of droplets positive in all data",
    y = "Number of Positive droplets",
    x = "Samples"
  )
```

```{r, fig.height = figHeight}


d %>%
  mutate(SampleType = ifelse(grepl(pattern = "East|West", x = Sample) & Spiked == "Unspiked", paste("Neg", icInfo), SampleType),
         SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
   # filter(Spiked == "Spiked") %>%
  ggplot(aes(x=Sample, y=pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  theme_light() +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = "Positive droplets per 10k droplets in all data",
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )


```

## Positive and negative controls

### Experiment controls with MHV signal

```{r Positive and negative control figures MHV, fig.height = figHeight}

#Negative controls
##Extraction
dControls %>%
  filter(exp_con == "Extraction control") %>%
  mutate(SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
  ggplot(aes(x=Sample, y=Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  theme_light() +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  labs(
    title = "Number of droplets positive in positive and negative controls",
    y = "Number of Positive droplets",
    x = "Samples"
  )

```

```{r, fig.height = figHeight}

dControls %>%
  filter(exp_con == "Extraction control") %>%
  mutate(SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
  ggplot(aes(x=Sample, y=pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  theme_light() +
  labs(
    title = "Positive droplets per 10k droplets in positive and negative controls",
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )
```


### Experimental controls with MHV removed

```{r Positive and negative control figures, fig.height = figHeight}

#Negative controls
##Extraction
dControls %>%
  filter(exp_con == "Extraction control",
         Target != icInfo) %>%
  mutate(SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
  ggplot(aes(x=Sample, y=Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  theme_light() +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  labs(
    title = "Number of droplets positive in positive and negative controls",
    y = "Number of Positive droplets",
    x = "Samples"
  )

```

```{r, fig.height = figHeight}

dControls %>%
  filter(exp_con == "Extraction control",
         Target != icInfo) %>%
  mutate(SampleType = ifelse(Sample == "oldWW", "NegCtrl", SampleType)) %>%
  ggplot(aes(x=Sample, y=pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  scale_fill_manual(values = c("firebrick1","limegreen",  "dodgerblue2")) +
  theme_light() +
  labs(
    title = "Positive droplets per 10k droplets in positive and negative controls",
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )
```

### ddPCR controls

```{r}

##ddPCR
dControls %>%
  filter(exp_con == "ddPCR control") %>%
  ggplot(aes(x=Sample, y=Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  theme_light() +
  labs(
    title = "Number of droplets positive in ddPCR controls",
    y = "Number of Positive droplets",
    x = "Samples"
  )


```


```{r}


dControls %>%
  filter(exp_con == "ddPCR control") %>%
  ggplot(aes(x=Sample, y=pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ SampleType, scales = "free_x") +
  scale_fill_manual(values = c("firebrick1", "limegreen", "dodgerblue2")) +
  theme_light() +
  labs(
    title = "Positive droplets per 10k droplets in ddPCR controls",
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )

```


## Limit of detection based on negative controls

Limit of detection is based on a positive signal being >3 positive droplets in a reaction well. >3 positive droplets roughly equates to ~0.5 genome copies per uL depending on total number of droplets.

Thus our limit of detection based on our concentration (Ceres NanoTrap) and extraction (MagMax wastewater ultra nucleic acid isolation kit) methods can be found with this formula:

LOD = 0.5 * (ddPCR reaction volume) / (template input volume) * (concentration output volume) / (concentration input volume) * (extraction output volume) / (extraction input volume)

where:

ddPCR reaction volume = 20 uL

template input volume = 9 uL

concentration output volume = 100 uL

concentration output volume = 400 uL

extraction output volume = 400 uL

extraction input volume = 9600 uL

# Results

##  Wastewater signal with MHV

```{r WW signal without MHV1, fig.height = figHeight}

d %>%
  filter(grepl(pattern = "NorthEast|SouthEast|SouthWest", x = Sample),
         #grepl(pattern = "concentrated", x = Process, ignore.case = T),
         Target != icInfo) %>%
  ggplot(aes(x = Sample, y = Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ ., scales = "free_x") +
  #scale_fill_manual(values = c("firebrick1", "dodgerblue2")) +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = paste("Number of droplets positive in wastewater samples without", icInfo, "signal"),
    y = "Number of Positive droplets",
    x = "Samples"
  )

```

```{r, fig.height = figHeight}


d %>%
  filter(grepl(pattern = "NorthEast|SouthEast|SouthWest", x = Sample),
         #grepl(pattern = "concentrated", x = Process, ignore.case = T),
         Target != icInfo) %>%
  ggplot(aes(x = Sample, y = pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ ., scales = "free_x") +
  theme_light() +
  #scale_fill_manual(values = c("firebrick1", "dodgerblue2")) +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = paste("Positive droplets per 10k droplets in wastewater samples without", icInfo, "signal"),
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )




```

## Wastewater signal with MHV and outliers removed

```{r WW signal without MHV, fig.height = figHeight}

d %>%
  filter(grepl(pattern = "NorthEast|SouthEast|SouthWest", x = Sample),
         #grepl(pattern = "concentrated", x = Process, ignore.case = T),
         Target != "MHV",
         !(Well %in% wellsToRemove),) %>%
  ggplot(aes(x = Sample, y = Positives, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ ., scales = "free_x") +
  #scale_fill_manual(values = c("firebrick1", "dodgerblue2")) +
  theme_light() +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = paste("Number of droplets positive in wastewater samples without", icInfo, "signal"),
    y = "Number of Positive droplets",
    x = "Samples"
  )

```

```{r, fig.height = figHeight, eval = FALSE}


d %>%
  filter(grepl(pattern = "NorthEast|SouthEast|SouthWest", x = Sample),
         #grepl(pattern = "concentrated", x = Process, ignore.case = T),
         Target != "MHV",
         !(Well %in% wellsToRemove),) %>%
  ggplot(aes(x = Sample, y = pos10k, fill = Target)) +
  geom_boxplot(position = "dodge") +
  geom_point(
    aes(fill = Target),
    shape = 21,
    size = 1.5,
    position = position_jitterdodge(jitter.width = 0.2)) +
  facet_grid(Sample_received ~ ., scales = "free_x") +
  theme_light() +
  #scale_fill_manual(values = c("firebrick1", "dodgerblue2")) +
  theme(
    axis.text.x = element_text(angle = 45,
                               vjust = 0.95,
                               hjust = 1)
  ) +
  labs(
    title = paste("Positive droplets per 10k droplets in wastewater samples without", icInfo, "signal"),
    y = "Positive droplets per 10k droplets",
    x = "Samples"
  )




```

\newpage

## Summarized signal

```{r summary}

pander(ww_conc_result_summarised,
       digits = 10, round = 2)

```

\newpage
\blandscape



## Wastewater original concentration

Based on conversations with other public health departments, we are no longer account for efficiency in final calculations for SC2 concentration in wastewater.

```{r wastewater stock concentration calculations}

pander(ww_conc_result,
       digits = 10, round = 2, split.table = 500)

```
\elandscape

