---
title: |
  ![](../aux_files/forKnitting/logo_blk.png){width=4.5in}  
  `r paste0('QC report for nasal swab sequencing run')`
  `r basename(here())`
author: "Philadelphia Public Health Labs"
date: \today
geometry: margin=3cm
output:
    pdf_document:
        template: ../aux_files/forKnitting/toc_after.tex
        keep_tex: false
        toc: true
        toc_depth: 3
        includes:
            in_header: ../aux_files/forKnitting/TeX_packages_commands.sty

---


\tableofcontents

\newpage

```{r filter out samples, message = TRUE, include=FALSE, eval = FALSE}

#this script filters the Excel file provided by the epidemiologist by excluding low RLU samples and samples received by the Health Centers
#the Excel file should be placed in the extra_metadata folder along with the environmental swabs file
#any samples from previous runs included should be placed in the prev_run folder, using the filtered Excel file
source("code/1_remove_low_RLU.R")

```

```{r generate SampleSheet and metadata, message = TRUE, include=FALSE, eval = FALSE}

#this script generates the SampleSheet.csv file required for demultiplexing the sequencing run
#the required file to include is the sequencing_metadata_sheet.xlsx filled out by the sequencing wet lab scientists, pertaining to the barcodes assigned to the samples
#the second sheet called 'Sample_Info' need to be filled out manually for proper sample annotation
source("code/2_generate_barcodes_IDT.R")

```

```{r child = 'code/preamble.Rmd', eval = load_preamble}
#load the data
```

```{r child = 'code/data_analysis.Rmd'}
#make the figures for the report
```

```{r generate time stamped report, message=TRUE, include=FALSE, eval=FALSE}
#generate the pdf report

### =============
### Manual inputs
### =============

# need to import the data into a single tsv for the first time?
import_data <- TRUE

# need the original accession numbers to report the results to DDC?
require_phi <- TRUE

### =================
### End manual inputs
### =================

rstudioapi::documentSaveAll()
library(here)
dir.create(here("output"))
project_name <- basename(here())

qc_report_fp <- paste0(project_name, "_QC_Report.Rmd")
qc_output_fp <- here("output", paste0(project_name, '.QC.report_gen.on.', Sys.Date(), '.pdf'))

# load preamble the first time?
load_preamble <- TRUE

# print table as kable for pdf?
use_kable <- TRUE
rmarkdown::render(qc_report_fp, output_file = qc_output_fp)

load_preamble <- FALSE
use_kable <- FALSE
rmarkdown::render(qc_report_fp, output_file = "README.md",
                 output_format = rmarkdown::md_document(variant = "gfm", toc = TRUE))

```

```{r run R script, include=FALSE, eval=FALSE}

rstudioapi::documentSaveAll()
library(here)

#run this script if exists
tryCatch(
  {
    source(file.path(dirname(here()), "cp2admin.R"))
  }, error = function(e)
  {

  }
)

```

```{r upload data if results look good, message=TRUE, include=FALSE, eval=FALSE}

### =============
### Manual inputs
### =============

#do a test upload first. change this to FALSE when SRA upload and gisaid upload testing is successful and you want to submit the files for real
test_upload <- TRUE 

#change this flag to FALSE to not use proxy
use_proxy <- TRUE 

#change this to FALSE to overwrite the submitted files on the sFTP and to resubmit
report_or_overwrite <- TRUE 

### =================
### End manual inputs
### =================

rstudioapi::documentSaveAll()
library(here)
library(readr)
library(tidyverse)

#intialize seqsender conda env
library(reticulate)
use_condaenv("seqsender", required = TRUE)
import("os")

#load variables
tryCatch(
  {
    source(file.path(dirname(here()), "aux_files", "config", "config_variables.R"))
  },
  error = function(e) {
  stop (simpleError("The config_variables.R file needs to sit in a [aux_files/config] directory path above this project directory"))
  }
)
#load functions
tryCatch(
  {
    source(file.path(dirname(here()), "aux_files", "functions", "R_all_functions_v3.R"))
  },
  error = function(e) {
  stop (simpleError("The R_all_functions_v3.R file needs to sit in a [aux_files/functions] directory path above this project directory"))
  }
)

project_name <- basename(here())
seqsender_py <- file.path(seqsender_fp, "seqsender.py")
seqsender_meta_fp <- here("upload", "seqsender", paste(project_name, "PHL2_seqsender_upload.tsv", sep = "_"))
fasta_fp <- here("upload", "fasta", paste0(project_name, "_PHL2_combined.fasta"))

seqsender <- read_tsv(seqsender_meta_fp)

#path of seqsender config file
seqsender_config_fp <- list.files(file.path(dirname(here()), "aux_files", "seqsender"), pattern = "seqsender_config.yaml", full.names = TRUE)
seqsender_config_test_fp <- list.files(file.path(dirname(here()), "aux_files", "seqsender"), pattern = "seqsender_config_test.yaml", full.names = TRUE)


if(test_upload) {
  test_flag <- "--test"
  config2use <- seqsender_config_test_fp
} else{
  test_flag <- ""
  config2use <- seqsender_config_fp
}

if(use_proxy) {
  proxy_flag <- "--proxy"
} else{
  proxy_flag <- ""
}

if(report_or_overwrite) {
  overwrite_flag <- ""
} else{
  overwrite_flag <- "--overwrite"
}

file_create_success_msg <- c(paste0("Processing ", project_name, "."),
                             "Processing Files.", 
                             "Creating GISAID files.",
                             "Creating Genbank files.",
                             "Creating BioSample/SRA files.",
                             paste0(project_name, " complete."))

### generate GISAID files to upload. This will also generate test submissions for SRA and BioSample but they will be rewritten with the submit command
upload_files_created <- cli_submit("python",
                                   seqsender_py,
                                   c(proxy_flag, "prep",
                                     "--unique_name", project_name,
                                     "--config", shQuote(seqsender_config_test_fp, type = "cmd"),
                                     "--metadata", shQuote(seqsender_meta_fp, type = "cmd"),
                                     "--fasta", shQuote(fasta_fp, type = "cmd")),
                                   shQuote_type = "cmd")

if(!all(file_create_success_msg %in% upload_files_created)) {
  stop(simpleError("Seqsender failed to create some of the GISAID upload files!"))
}

gisaid_upload_success_msg <- c("Submitting now to gisaid.",
                               "Waiting for file to write.",
                               "No failed sequences.",
                               "Cleaning up files.")

### submit files to gisaid
gisaid_uploaded <- cli_submit("python",
                              seqsender_py,
                              c(proxy_flag, "gisaid",
                                "--unique_name", project_name,
                                "--config", shQuote(config2use, type = "cmd"),
                                test_flag, overwrite_flag),
                              shQuote_type = "cmd")

if(!all(gisaid_upload_success_msg %in% gisaid_uploaded)) {
  stop(simpleError("Something went wrong! GISAID upload failed. Maybe there are duplicate entries already? If so, rename the GISAID name and resubmit"))
}

#include the GISAID Accession number for the SRA and GenBank submissions
read_gisaid_accessions <- read_csv(here("gisaid", paste0(project_name, ".log")), col_names = FALSE) %>%
  filter(grepl("msg: ", X1)) %>%
  mutate(X1 = gsub("msg: ", "", X1))

gisaid_number_submitted <- read_gisaid_accessions %>%
  filter(grepl("submissions uploaded: ", X1)) %>%
  mutate(X1 = gsub("submissions uploaded: ", "", X1)) %>%
  pull() %>%
  as.numeric()

gisaid_number_failed <- read_gisaid_accessions %>%
  filter(grepl("submissions failed: ", X1)) %>%
  mutate(X1 = gsub("submissions failed: ", "", X1)) %>%
  pull() %>%
  as.numeric()

if(gisaid_number_submitted != nrow(seqsender) & gisaid_number_failed != 0) {
  
  stop(simpleError("Some GISAID samples failed to upload."))
  
}
  
gisaid_accessions <- read_gisaid_accessions %>%
  filter(!grepl("submissions uploaded: |submissions failed: ", X1)) %>%
  separate(X1, into = c("gisaid_name", "gisaid_accession"), sep = "; ", extra = "merge") %>%
  mutate(genbank_note = paste0("GISAID virus name: ", gisaid_name, "; GISAID accession: ", gisaid_accession))
  
if(!test_upload) {
  
  gisaid_accessions %>%
    write_csv(here("gisaid", paste0(project_name, "_gisaid_accessions.csv")))
  
}

#rewrite the seqsender file with the gisaid accession numbers and remove the old prepared files
seqsender %>%
  select(-c(gisaid_accession, genbank_note)) %>%
  merge(gisaid_accessions, by = "gisaid_name", all.x = TRUE) %>%
  write_tsv(seqsender_meta_fp)

### submit files to biosample and sra
cli_submit("python",
           seqsender_py,
           c(proxy_flag, "submit",
             "--unique_name", project_name,
             "--config", shQuote(config2use, type = "cmd"),
             "--metadata", shQuote(seqsender_meta_fp, type = "cmd"),
             "--fasta", shQuote(fasta_fp, type = "cmd"),
             test_flag, overwrite_flag),
           shQuote_type = "cmd")

### submit files to genbank
cli_submit("python",
           seqsender_py,
           c(proxy_flag, "genbank",
             "--unique_name", project_name,
             "--config", shQuote(config2use, type = "cmd"),
             test_flag, overwrite_flag),
           shQuote_type = "cmd")
```
